#!/bin/bash

cachedir="$HOME/.cache/dmenu_custom"
configdir="$HOME/.config/dmenu_custom"
aliasesfile="$configdir/aliases"
lockfile="$cachedir/lock"
cache_desktop_cmd_global="$cachedir/dmenu_desktop_cmd_global"
cache_desktop_cmd_local="$cachedir/dmenu_desktop_cmd_local"
cache_desktop_cmd_flatpak="$cachedir/dmenu_desktop_cmd_flatpak"

checkrunning()
{
    if [[ -f "$lockfile" ]]
    then
        echo "Already running!"
        exit 1
    else
        touch "$lockfile"
    fi
}

execute()
{
    if [[ -n $1 ]]
    then
        if [[ -f "$aliasesfile" ]] && grep -qF "alias $1=" "$aliasesfile"
        then
            cmd=$(grep "alias $1=" "$aliasesfile" | sed "s/alias $1=//g")
        elif grep -q "^$1;" "$cache_desktop_cmd_global"
        then
            cmd=$(grep "^$1;" "$cache_desktop_cmd_global" | awk -F "; " '{print $2}')
        elif grep -q "^$1;" "$cache_desktop_cmd_local"
        then
            cmd=$(grep "^$1;" "$cache_desktop_cmd_local" | awk -F "; " '{print $2}')
        elif grep -q "^$1;" "$cache_desktop_cmd_flatpak"
        then
            cmd=$(grep "^$1;" "$cache_desktop_cmd_flatpak" | awk -F "; " '{print $2}')
        else
            cmd="$1"
        fi
        printf "$cmd" | ${SHELL:-"/bin/sh"}
    fi
}

checkrunning
selection=$( (dmenu_path && dmenu_desktop && dmenu_aliases) 2>/dev/null | sort -u | dmenu "$@" )
rm "$lockfile"
execute "$selection"
