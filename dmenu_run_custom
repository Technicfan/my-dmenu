#!/bin/bash

if [[ $(pgrep -f dmenu_run_custom | wc -l) != 2 ]]
then
    echo "Already running!"
    exit 1
fi

cachedir="$HOME/.cache/dmenu_desktop"
aliases_file="$HOME/.config/dmenu/aliases"
cache_desktop_cmd_global="$cachedir/dmenu_desktop_cmd_global"
cache_desktop_cmd_local="$cachedir/dmenu_desktop_cmd_local"

execute()
{
    if [[ -n $1 ]]
    then
        if [[ -f "$aliases_file" ]] && grep -qF "$1=" "$aliases_file"
        then
            cmd=$(grep "$1=" "$aliases_file" | sed "s/alias $1=//g")
        elif grep -qF "$1;" "$cache_desktop_cmd_global"
        then
            cmd=$(grep "$1;" "$cache_desktop_cmd_global" | awk -F "; " '{print $2}')
        elif grep -qF "$1" "$cache_desktop_cmd_local"
        then
            cmd=$(grep "$1" "$cache_desktop_cmd_local" | awk -F "; " '{print $2}')
        else
            cmd="$1"
        fi
        printf "$cmd" | ${SHELL:-"/bin/sh"}
    fi
}

selection=$( (dmenu_path && dmenu_desktop && dmenu_aliases) | sort -u | dmenu "$@" )
execute "$selection"
